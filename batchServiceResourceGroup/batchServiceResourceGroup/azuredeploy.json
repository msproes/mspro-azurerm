{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "baseName": {
      "type": "string",
      "defaultValue": "[ResourceGroup().name]",
      "metadata": {
        "description": "Prefix used for naming all the resources. Must be globally unique and 3 to 13 characters long."
      },
      "minLength": 3,
      "maxLength": 61
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Batch Account location"
      }
    },

    "userUsername": {
      "type": "string",
      "defaultValue": "usr",
      "minLength": 3,
      "maxLength": 15,
      "metadata": {
        "description": "Name for the User account created in all VMs"
      }
    },
    "userPassword": {
      "type": "securestring",
      "metadata": {
        "description": "User account password"
      }
    },

    "adminUsername": {
      "type": "string",
      "defaultValue": "adm",
      "minLength": 3,
      "maxLength": 15,
      "metadata": {
        "description": "Name for the Administrator account created in all VMs"
      }
    },

    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Administrator account password"
      }
    },
    "vmSize": {
      "type": "string",
      "defaultValue": "Standard_A1_v2",
      "allowedValues": [
        "Standard_A1_v2",
        "Standard_A2_v2"
      ],
      "metadata": {
        "description": "Size for the Virtual Machines used in the Batch Account Pool"
      }
    },
    "vmOSType": {
      "type": "string",
      "defaultValue": "0 - UbuntuServer  16.04.0-LTS",
      "allowedValues": [
        "0 - UbuntuServer  16.04.0-LTS",
        "1 - WindowsServer 2016-Datacenter-smalldisk",
        "2 - WindowsServer 2016-Datacenter",
        "3 - WindowsServer 2012-R2-Datacenter-smalldisk",
        "4 - WindowsServer 2012-R2-Datacenter"
      ],
      "metadata": {
        "description": "VM OS Image used for the Virtual Machines Nodes in Batch Account Pool"
      }
    },
    "storageAccountName": {
      "type": "string",
      "defaultValue": null,
      "metadata": {
        "description": "Storage Account Name to associate with the Batch Account"
      }
    },
    "keyVaultResourceGroupName": {
      "type": "string",
      "defaultValue": "[ResourceGroup().name]",
      "metadata": {
        "description": "Key Vault resource group name"
      }
    },
    "keyVaultName": {
      "type": "string",
      "defaultValue": "keyVault",
      "metadata": {
        "description": "Key Vault name"
      }
    },

    "omsResourceGroupName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "OMS Workspace resource group name"
      }
    },
    "omsName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "OSM Workspace name"
      }
    }
  },
  "variables": {
    "vmTypes": [
      {
        "name": "UB1604",
        "publisher": "Canonical",
        "offer": "UbuntuServer",
        "sku": "16.04.0-LTS",
        "nodeAgentSkuId": "batch.node.ubuntu 16.04"
      },
      {
        "name": "WS2016small",
        "publisher": "MicrosoftWindowsServer",
        "offer": "WindowsServer",
        "sku": "2016-Datacenter-smalldisk",
        "nodeAgentSkuId": "batch.node.windows amd64"
      },
      {
        "name": "WS2016",
        "publisher": "MicrosoftWindowsServer",
        "offer": "WindowsServer",
        "sku": "2016-Datacenter",
        "nodeAgentSkuId": "batch.node.windows amd64"
      },
      {
        "name": "WS2012R2small",
        "publisher": "MicrosoftWindowsServer",
        "offer": "WindowsServer",
        "sku": "2012-R2-Datacenter-smalldisk",
        "nodeAgentSkuId": "batch.node.windows amd64"
      },
      {
        "name": "WS2012R2",
        "publisher": "MicrosoftWindowsServer",
        "offer": "WindowsServer",
        "sku": "2012-R2-Datacenter",
        "nodeAgentSkuId": "batch.node.windows amd64"
      }
    ],
    "vmOSTypeIndex": "[int(first(parameters('vmOSType')))]",
    "longNamingInfix": "[toLower(parameters('baseName'))]",
    "namingInfix": "[toLower(substring(concat(parameters('baseName'), uniqueString(resourceGroup().id)), 0, 13))]",
    "batchaccSuffix": {
      "type": "string",
      "defaultValue": "batchacc",
      "metadata": {
        "description": "Suffix for naming the batch account. Must be globally unique and 3 to 10 characters long."
      },
      "minLength": 3,
      "maxLength": 61
    },
    "storageAccountNameSuffix": "storageacc",
    "batchAccountNameSuffix" : "batchacc",
    "storageAccountName": "[concat(variables('namingInfix'), variables('storageAccountNameSuffix'))]",
    "storageAccountId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
    "storageApiVersion": "[providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]]",
    "batchAccountName": "[concat(variables('namingInfix'), variables('batchAccountNameSuffix'))]",
    "batchResourceId": "[resourceId('Microsoft.Batch/batchAccounts', variables('batchAccountName'))]",
    "batchApiVersion": "[providers('Microsoft.Batch', 'batchAccounts').apiVersions[0]]",
    "batchSecretName": "[concat(parameters('baseName'),'2batchSecret')]",
    "keyVaultResourceId": "[[resourceId(subscription().subscriptionId,  parameters('keyVaultResourceGroupName'), 'Microsoft.KeyVault/vaults', parameters('keyVaultName'))]]",
    "poolName": "[concat(variables('batchAccountName'), '-Pool01')]",
    "serverPublisher": "variables('serverType')[variables('vmOSTypeIndex')].publisher",
    "serverOffer": "variables('serverType')[variables('vmOSTypeIndex')].offer",
    "serverSku": "variables('serverType')[variables('vmOSTypeIndex')].sku",
    "serverNodeAgent": "variables('serverType')[variables('vmOSTypeIndex')].nodeAgentSkuId",
    "poolDedicatedNodes": 0,
    "poolLowPriNodes": 0,
    "defaultKeyVault": {
      "id": "[resourceId(parameters('keyVaultResourceGroupName'),'Microsoft.KeyVault/vaults',parameters('keyVaultName'))]"
    },
    "vnetResourceGroup": "[resourceGroup().name]",
    "vnetName": "batch-vnet",
    "vnetID": "[resourceId(variables('vnetResourceGroup'),'Microsoft.Network/virtualNetworks',variables('vnetName'))]",
    "vnetSubnet1Name": "batch-vnetSubnet1",
    "vnetSubnet1Ref": "[concat(variables('vnetID'),'/subnets/',variables('vnetSubnet1Name'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Storage/storageAccounts",
      "name": "[variables('storageAccountname')]",
      "apiVersion": "2016-01-01",
      "location": "[parameters('location')]",
      "comments": "This storage account is used to associate to a batch account",
      "sku": {
        "name": "[parameters('storageAccountsku')]"
      },
      "kind": "Storage",
      "tags": {
        "ObjectName": "[variables('storageAccountName')]"
      },
      "properties": {}
    },
    {
      "type": "Microsoft.Batch/batchAccounts",
      "name": "[variables('batchAccountName')]",
      "apiVersion": "2015-12-01",
      "location": "[parameters('location')]",
      "tags": {
        "objectName": "[variables('batchAccountName')]"
      },
      "properties": {
        "autoStorage": {
          "storageAccountId": "[parameters('storageAccountId')]"
        }
      }
    },
    {
      "type": "Microsoft.Batch/batchAccounts/pools",
      "name": "[concat(variables('batchAccountName'), '/', variables('poolName'))]",
      "apiVersion": "2017-09-01",
      "properties": {
        "vmSize": "[parameters('vmSize')]",
        "deploymentConfiguration": {
          "virtualMachineConfiguration": {
            "imageReference": {
              "publisher": "[variables('vmTypes')[variables('vmOSTypeIndex')].publisher]",
              "offer": "[variables('vmTypes')[variables('vmOSTypeIndex')].offer]",
              "sku": "[variables('vmTypes')[variables('vmOSTypeIndex')].sku]",
              "version": "latest"
            },
            "nodeAgentSkuId": "[variables('vmTypes')[variables('vmOSTypeIndex')].nodeAgentSkuId]"
          }
        },
        "scaleSettings": {
          "fixedScale": {
            "targetDedicatedNodes": "[variables('poolDedicatedNodes')]",
            "targetLowPriorityNodes": "[variables('poolLowPriNodes')]"
          }
        }
      },
      "dependsOn": [
        "[concat('Microsoft.Batch/batchAccounts/', variables('batchAccountName'))]"
      ]
    }
  ],
  "outputs": {
    "storageAccountName": {
      "type": "string",
      "value": "[variables('storageAccountName')]"
    },
    "storageAccountId": {
      "type": "string",
      "value": "[variables('storageAccountId')]"

    },
    "batchAccountName": {
      "type": "string",
      "value": "[variables('batchAccountName')]"
    },
    "storageObject": {
      "type": "object",
      "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')))]"
    },
    "batchObject": {
      "type": "object",
      "value": "[reference(resourceId('Microsoft.Batch/batchAccounts', variables('batchAccountName')))]"
    },
    "keyVaultResourceId": {
      "type": "string",
      "value": "[variables('keyVaultResourceId')]"
    },
    "batchPrimaryKey": {
      "type": "string",
      "value": "[listKeys(variables('batchResourceId'), variables('batchApiVersion')).primary]"
    },
    "deploymentUri": {
      "type": "string",
      "value": "https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fmsproes%2Fmspro-azurerm%2Fmaster%2FbatchServiceResourceGroup%2FbatchServiceResourceGroup%2Fazuredeploy.json"
    }
  }
}
