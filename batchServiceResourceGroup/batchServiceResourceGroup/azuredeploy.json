{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "baseName": {
      "type": "string",
      "defaultValue": "[ResourceGroup().name]",
      "metadata": {
        "description": "Prefix used for naming all the resources. Must be globally unique and 3 to 13 characters long."
      },
      "minLength": 3,
      "maxLength": 61
    },
    "batchaccSuffix": {
      "type": "string",
      "defaultValue": "batchacc",
      "metadata": {
        "description": "Suffix for naming the batch account. Must be globally unique and 3 to 10 characters long."
      },
      "minLength": 3,
      "maxLength": 61
    },
    "storageaccSuffix": {
      "type": "string",
      "defaultValue": "storageacc",
      "metadata": {
        "description": "Suffix for naming the storage account. Must be globally unique and 3 to 10 characters long."
      },
      "minLength": 3,
      "maxLength": 61
    },
    "poolNodes": {
      "type": "int",
      "defaultValue": 0,
      "metadata": {
        "description": "Number of Nodes in Pool"
      },
      "minValue": 0,
      "maxValue": 100
    },
    "userUsername": {
      "type": "string",
      "defaultValue": "usr",
      "minLength": 3,
      "maxLength": 15,
      "metadata": {
        "description": "User username on all VMs"
      }
    },

    "adminUsername": {
      "type": "string",
      "defaultValue": "adm",
      "minLength": 3,
      "maxLength": 15,
      "metadata": {
        "description": "Administrator username on all VMs"
      }
    },
    "userPassword": {
      "type": "securestring",
      "metadata": {
        "description": "User password on all VMs"
      }
    },
    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Administrator password on all VMs"
      }
    },

    "storageAccountSku": {
      "type": "string",
      "defaultValue": "Standard_LRS",
      "allowedValues": [
        "Standard_LRS",
        "Standard_GRS",
        "Standard_ZRS",
        "Premium_LRS"
      ],
      "metadata": {
        "description": "Storage Account type"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources."
      }
    },
    "vmSize": {
      "type": "string",
      "defaultValue": "Standard_A2_v2",
      "allowedValues": [
        "Standard_A2_v2",
        "Standard_A1_v2"
      ],
      "metadata": {
        "description": "Size for the Virtual Machines used in the Batch Account Pool"
      }
    },
    "vmOSType": {
      "type": "string",
      "defaultValue": "0 - UbuntuServer 16.04.0-LTS",
      "allowedValues": [
        "0 - UbuntuServer 16.04.0-LTS",
        "1 - WindowsServer 2016-Datacenter-smalldisk",
        "2 - WindowsServer 2016-Datacenter",
        "3 - WindowsServer 2012-R2-Datacenter-smalldisk",
        "4 - WindowsServer 2012-R2-Datacenter"
      ],
      "metadata": {
        "description": "VM OS Image used for the Virtual Machines Nodes in Batch Account Pool"
      }
    }
  },
  "variables": {
    "longNamingInfix": "[toLower(parameters('baseName'))]",
    "namingInfix": "[toLower(substring(concat(parameters('baseName'), uniqueString(resourceGroup().id)), 0, 13))]",
    "storageAccountName": "[concat(variables('namingInfix'), parameters('storageaccSuffix'))]",
    "storageResourceId": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
    "storageApiVersion": "[providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]]",
    "batchAccountName": "[concat(variables('namingInfix'), parameters('batchaccSuffix'))]",
    "batchResourceId": "[resourceId('Microsoft.Batch/batchAccounts', variables('batchAccountName'))]",
    "batchApiVersion": "[providers('Microsoft.Batch', 'batchAccounts').apiVersions[0]]",
    "batchSecretName": "[concat(parameters('baseName'),'2batchSecret')]",
    "keyVaultResourceId": "[[resourceId(subscription().subscriptionId,  parameters('keyVaultResourceGroup'), 'Microsoft.KeyVault/vaults', parameters('keyVaultName'))]]",
    "poolName": "[concat(variables('batchAccountName'), '-Pool01')]",
    "serverPublisher": "variables('serverType')[variables('vmOSTypeIndex')]",
    "serverOffer": "UbuntuServer",
    "serverSku": "16.04.0-LTS",
    "serverNodeAgent": "batch.node.ubuntu 16.04",
    "poolDedicatedNodes": "[parameters('poolNodes')]",
    "poolLowPriNodes": "[parameters('poolNodes')]",
    "defaultKeyVault": {
      "id": "/subscriptions/20a54399-d893-4069-a673-a3722808438d/resourceGroups/batch-rg/providers/Microsoft.KeyVault/vaults/bskv01"
    },
    "vmOSTypeIndex": "[int(first(parameters('vmOSType')))]",
    "vmTypes": [
      {
        "name": "UB1604",
        "publisher": "Canonical",
        "offer": "UbuntuServer",
        "sku": "16.04.0-LTS",
        "nodeAgentSkuId": "batch.node.ubuntu 16.04"
      },
      {
        "name": "WS2016small",
        "publisher": "MicrosoftWindowsServer",
        "offer": "WindowsServer",
        "sku": "2016-Datacenter-smalldisk",
        "nodeAgentSkuId": "batch.node.windows amd64"
      },
      {
        "name": "WS2016",
        "publisher": "MicrosoftWindowsServer",
        "offer": "WindowsServer",
        "sku": "2016-Datacenter",
        "nodeAgentSkuId": "batch.node.windows amd64"
      },
      {
        "name": "WS2012R2small",
        "publisher": "MicrosoftWindowsServer",
        "offer": "WindowsServer",
        "sku": "2012-R2-Datacenter-smalldisk",
        "nodeAgentSkuId": "batch.node.windows amd64"
      },
      {
        "name": "WS2012R2",
        "publisher": "MicrosoftWindowsServer",
        "offer": "WindowsServer",
        "sku": "2012-R2-Datacenter",
        "nodeAgentSkuId": "batch.node.windows amd64"
      }
    ]
  },
  "resources": [
    {
      "type": "Microsoft.Storage/storageAccounts",
      "name": "[variables('storageAccountname')]",
      "apiVersion": "2016-01-01",
      "location": "[parameters('location')]",
      "comments": "This storage account is used to associate to a batch account",
      "sku": {
        "name": "[parameters('storageAccountsku')]"
      },
      "kind": "Storage",
      "tags": {
        "ObjectName": "[variables('storageAccountName')]"
      },
      "properties": {}
    },
    {
      "type": "Microsoft.Batch/batchAccounts",
      "name": "[variables('batchAccountName')]",
      "apiVersion": "2015-12-01",
      "location": "[parameters('location')]",
      "tags": {
        "ObjectName": "[variables('batchAccountName')]"
      },
      "properties": {
        "autoStorage": {
          "storageAccountId": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
      ]
    },
    {
      "type": "Microsoft.Batch/batchAccounts/pools",
      "name": "[concat(variables('batchAccountName'), '/', variables('poolName'))]",
      "apiVersion": "2017-09-01",
      "properties": {
        "displayName": "[variables('poolName')]",
        "vmSize": "[parameters('vmSize')]",
        "deploymentConfiguration": {
          "virtualMachineConfiguration": {
            "imageReference": {
              "publisher": "[variables('vmTypes')[variables('vmOSTypeIndex')].publisher]",
              "offer": "[variables('vmTypes')[variables('vmOSTypeIndex')].offer]",
              "sku": "[variables('vmTypes')[variables('vmOSTypeIndex')].sku]",
              "version": "latest"
            },
            "nodeAgentSkuId": "[variables('vmTypes')[variables('vmOSTypeIndex')].nodeAgentSkuId]"
          }
        },
        "scaleSettings": {
          "fixedScale": {
            "targetDedicatedNodes": "[variables('poolDedicatedNodes')]",
            "targetLowPriorityNodes": "[variables('poolLowPriNodes')]"
          }
        },
        "userAccounts": [
          {
            "name": "[parameters('userUserName')]",
            "password": "[parameters('userPassword')]",
            "elevationLevel": "NonAdmin"
          },
          {
            "name": "[parameters('adminUserName')]",
            "password": "[parameters('adminPassword')]",
            "elevationLevel": "Admin"
          }
        ]
      },
      "dependsOn": [
        "[concat('Microsoft.Batch/batchAccounts/', variables('batchAccountName'))]"
      ]
    }
  ],
  "outputs": {
    "storageAccountName": {
      "type": "string",
      "value": "[variables('storageAccountName')]"
    },
    "storageResourceId": {
      "type": "string",
      "value": "[variables('storageResourceId')]"

    },
    "batchAccountName": {
      "type": "string",
      "value": "[variables('batchAccountName')]"
    },
    "storageObject": {
      "type": "object",
      "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')))]"
    },
    "batchObject": {
      "type": "object",
      "value": "[reference(resourceId('Microsoft.Batch/batchAccounts', variables('batchAccountName')))]"
    },
    "keyVaultResourceId": {
      "type": "string",
      "value": "[variables('keyVaultResourceId')]"
    },
    "batchPrimaryKey": {
      "type": "string",
      "value": "[listKeys(variables('batchResourceId'), variables('batchApiVersion')).primary]"
    },
    "deploymentUri": {
      "type": "string",
      "value": "https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fmsproes%2Fmspro-azurerm%2Fmaster%2FbatchServiceResourceGroup%2FbatchServiceResourceGroup%2Fazuredeploy.json"
    }
  }
}
